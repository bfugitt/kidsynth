<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Sound Garden</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #FDFBF7; /* Creamy paper */
            background-image: radial-gradient(#E5E7EB 1px, transparent 1px);
            background-size: 20px 20px;
            touch-action: manipulation; 
            user-select: none; /* Prevent text selection while clicking fast */
        }

        /* Custom Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #D4A373;
            border: 3px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            cursor: pointer;
            margin-top: -8px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #E7E5E4;
            border-radius: 2px;
        }

        /* Hide scrollbars for cleaner look */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* --- Grid & Playhead Animations --- */

        .grid-cell {
            transition: transform 0.15s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.1s, box-shadow 0.1s;
        }

        /* The vertical line effect for the column currently playing */
        .playhead-column {
            background-color: #F5F5F4 !important; /* Stone-100 */
            border-color: #D6D3D1 !important; /* Stone-300 */
        }

        /* The specific note being triggered */
        .playhead-active-note {
            transform: scale(1.15);
            box-shadow: 0 0 0 4px #D4A373 !important; /* Ring highlight */
            z-index: 10;
            filter: brightness(1.05);
        }

    </style>
</head>
<body class="text-stone-700 h-screen flex flex-col overflow-hidden">

    <!-- Header / Controls -->
    <header class="bg-white border-b border-stone-200 p-3 shadow-sm z-10 shrink-0">
        <div class="max-w-7xl mx-auto flex flex-wrap items-center justify-between gap-4">
            
            <!-- Title -->
            <div class="flex items-center gap-2">
                <div class="bg-stone-800 text-white w-8 h-8 rounded-full flex items-center justify-center text-lg shadow-sm">ðŸŽµ</div>
                <h1 class="text-xl font-bold tracking-tight text-stone-800 hidden md:block">Sound Garden</h1>
            </div>

            <!-- Main Controls -->
            <div class="flex flex-1 justify-center">
                <div class="flex items-center gap-4 sm:gap-6 bg-stone-50 px-4 py-2 rounded-full border border-stone-200 shadow-inner">
                    <!-- Play Button -->
                    <button id="play-btn" class="bg-stone-800 hover:bg-stone-700 text-white font-bold py-1 px-6 rounded-full transition-colors shadow-md text-base min-w-[80px]">
                        Play
                    </button>

                    <!-- Tempo -->
                    <div class="flex flex-col w-24 sm:w-32">
                        <label class="text-[10px] font-bold text-stone-400 uppercase tracking-wider">Speed: <span id="tempo-val">120</span></label>
                        <input type="range" id="tempo" min="60" max="200" value="120">
                    </div>

                    <!-- Filter (Brightness) -->
                    <div class="flex flex-col w-24 sm:w-32">
                        <label class="text-[10px] font-bold text-stone-400 uppercase tracking-wider">Brightness</label>
                        <input type="range" id="filter-cutoff" min="0" max="100" value="100" title="Lowpass Filter">
                    </div>

                    <!-- Waveform -->
                    <div class="hidden sm:flex flex-col">
                        <label class="text-[10px] font-bold text-stone-400 uppercase tracking-wider">Sound</label>
                        <select id="waveform" class="bg-transparent text-sm font-bold text-stone-700 focus:outline-none cursor-pointer">
                            <option value="triangle">Soft (Triangle)</option>
                            <option value="sine">Pure (Sine)</option>
                            <option value="square">Retro (Square)</option>
                            <option value="sawtooth">Sharp (Saw)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Tools -->
            <div class="flex gap-2">
                <button id="clear-btn" class="text-stone-400 hover:text-red-500 font-bold text-xs px-2 py-1">Clear Grid</button>
            </div>
        </div>
    </header>

    <!-- Main Workspace -->
    <main class="flex-1 relative flex flex-col items-center justify-center bg-stone-50 overflow-hidden p-2 sm:p-4">
        
        <!-- The Grid Card -->
        <div class="bg-white p-4 rounded-2xl shadow-xl border border-stone-100 w-full max-w-7xl flex flex-col h-full overflow-hidden relative">
            
            <!-- Grid container -->
            <div id="grid" class="grid gap-1 sm:gap-2 w-full flex-1 min-h-0"></div>
            
            <!-- Pitch Labels -->
            <div class="flex justify-between mt-2 text-[10px] text-stone-400 font-bold uppercase tracking-widest shrink-0">
                <span>Low Pitch</span>
                <span>High Pitch</span>
            </div>
        </div>

    </main>

    <!-- Footer: Song Library -->
    <footer class="bg-white border-t border-stone-200 h-32 shrink-0 z-10">
        <div class="max-w-7xl mx-auto h-full flex flex-col justify-center px-6">
            <h3 class="text-[10px] font-bold text-stone-400 uppercase tracking-wider mb-2">My Compositions</h3>
            <!-- Song Slots Container -->
            <div id="song-list" class="flex gap-4 overflow-x-auto pb-2 scrollbar-hide h-full items-start">
                <!-- Slots injected by JS -->
            </div>
        </div>
    </footer>

    <script>
        /**
         * SECTION 1: CONFIGURATION
         */
        const CONFIG = {
            rows: 8,
            cols: 16,
            colors: {
                activeTile: '#8B9D83', // Sage Green
                activeBorder: '#788773',
                inactiveTile: '#FFFFFF',
                inactiveBorder: '#E7E5E4' // Stone-200
            }
        };

        /**
         * SECTION 2: AUDIO ENGINE
         */
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();

        const masterGain = audioCtx.createGain();
        masterGain.gain.value = 0.4;
        masterGain.connect(audioCtx.destination);

        // Reverb Effect
        const reverbNode = audioCtx.createConvolver();
        const reverbGain = audioCtx.createGain();
        reverbGain.gain.value = 0.3; 
        reverbNode.connect(reverbGain);
        reverbGain.connect(masterGain);
        masterGain.connect(reverbNode);

        function createImpulse() {
            const rate = audioCtx.sampleRate;
            const length = rate * 2.0; 
            const decay = 2.0;
            const impulse = audioCtx.createBuffer(2, length, rate);
            const left = impulse.getChannelData(0);
            const right = impulse.getChannelData(1);
            for (let i = 0; i < length; i++) {
                const n = length - i;
                left[i] = (Math.random() * 2 - 1) * Math.pow(1 - n / length, decay);
                right[i] = (Math.random() * 2 - 1) * Math.pow(1 - n / length, decay);
            }
            return impulse;
        }
        reverbNode.buffer = createImpulse();

        const PENTATONIC_SCALE = [0, 2, 4, 7, 9, 12, 14, 16];

        class Synthesizer {
            constructor() {
                this.waveform = 'triangle';
            }

            setWaveform(type) {
                if(['sine', 'square', 'sawtooth', 'triangle'].includes(type)) {
                    this.waveform = type;
                }
            }

            playNote(row, duration) {
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }

                // VCF (Filter) Logic
                const filterSliderVal = document.getElementById('filter-cutoff').value;
                const cutoffFreq = 200 * Math.pow(12000/200, filterSliderVal/100);

                const invertedRow = (CONFIG.rows - 1) - row;
                const rootNote = 60; 
                const noteIndex = invertedRow % PENTATONIC_SCALE.length;
                const octaveOffset = Math.floor(invertedRow / PENTATONIC_SCALE.length) * 12;
                const midiNote = rootNote + PENTATONIC_SCALE[noteIndex] + octaveOffset;
                const freq = 440 * Math.pow(2, (midiNote - 69) / 12);

                const osc = audioCtx.createOscillator();
                const filter = audioCtx.createBiquadFilter(); 
                const gain = audioCtx.createGain();

                osc.type = this.waveform;
                osc.frequency.value = freq;

                filter.type = 'lowpass';
                filter.frequency.value = cutoffFreq;
                filter.Q.value = 1;

                osc.connect(filter);
                filter.connect(gain);
                gain.connect(masterGain);

                const now = audioCtx.currentTime;
                const attack = 0.05;
                const release = 0.3;

                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.5, now + attack);
                gain.gain.exponentialRampToValueAtTime(0.001, now + duration + release);

                osc.start(now);
                osc.stop(now + duration + release + 0.1);
                
                setTimeout(() => {
                    osc.disconnect();
                    filter.disconnect();
                    gain.disconnect();
                }, (duration + release + 1) * 1000);
            }
        }
        const synth = new Synthesizer();


        /**
         * SECTION 3: SONG STORAGE MANAGER
         */
        class SongManager {
            constructor() {
                this.storageKey = 'soundGarden_songs_v1';
                // Initialize with 6 empty slots if none exist
                this.slots = this.loadSlots() || [null, null, null, null, null, null];
            }

            loadSlots() {
                const data = localStorage.getItem(this.storageKey);
                return data ? JSON.parse(data) : null;
            }

            saveSlots() {
                localStorage.setItem(this.storageKey, JSON.stringify(this.slots));
            }

            saveSong(index, songData) {
                this.slots[index] = songData;
                this.saveSlots();
                this.renderUI();
            }

            deleteSong(index) {
                if(confirm("Delete this composition?")) {
                    this.slots[index] = null;
                    this.saveSlots();
                    this.renderUI();
                }
            }

            // Render the footer cards
            renderUI() {
                const container = document.getElementById('song-list');
                container.innerHTML = '';

                this.slots.forEach((song, index) => {
                    const card = document.createElement('div');
                    
                    // Common card styles
                    card.className = `
                        flex-shrink-0 w-24 h-20 rounded-lg border-2 flex flex-col items-center justify-center relative
                        transition-all duration-200 cursor-pointer
                    `;

                    if (song) {
                        // FILLED SLOT
                        card.classList.add('bg-stone-100', 'border-stone-300', 'hover:border-stone-500', 'group');
                        card.innerHTML = `
                            <div class="text-2xl">ðŸŽµ</div>
                            <div class="text-[10px] font-bold text-stone-600 mt-1">Song ${index + 1}</div>
                            <button class="delete-btn absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity shadow-sm z-10">Ã—</button>
                        `;
                        
                        // Load click
                        card.addEventListener('click', (e) => {
                            if(!e.target.classList.contains('delete-btn')) {
                                loadSongIntoApp(song);
                            }
                        });

                        // Delete click
                        const delBtn = card.querySelector('.delete-btn');
                        delBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.deleteSong(index);
                        });

                    } else {
                        // EMPTY SLOT
                        card.classList.add('bg-white', 'border-dashed', 'border-stone-300', 'text-stone-300', 'hover:text-stone-500', 'hover:border-stone-500', 'hover:bg-stone-50');
                        card.innerHTML = `
                            <div class="text-2xl font-light">+</div>
                            <div class="text-[10px] font-bold">Save</div>
                        `;
                        
                        // Save click
                        card.addEventListener('click', () => {
                            const data = captureAppState();
                            this.saveSong(index, data);
                        });
                    }

                    container.appendChild(card);
                });
            }
        }
        const songManager = new SongManager();


        /**
         * SECTION 4: MAIN APP LOGIC
         */
        
        const gridContainer = document.getElementById('grid');
        const playBtn = document.getElementById('play-btn');
        const tempoSlider = document.getElementById('tempo');
        const tempoVal = document.getElementById('tempo-val');
        const waveSelector = document.getElementById('waveform');
        const filterSlider = document.getElementById('filter-cutoff');
        const clearBtn = document.getElementById('clear-btn');

        let isPlaying = false;
        let currentStep = 0;
        let intervalId = null;
        let gridState = Array(CONFIG.rows).fill().map(() => Array(CONFIG.cols).fill(false));

        function init() {
            createGrid();
            songManager.renderUI();
            
            playBtn.addEventListener('click', togglePlay);
            clearBtn.addEventListener('click', clearGrid);
            
            tempoSlider.addEventListener('input', (e) => {
                tempoVal.textContent = e.target.value;
                if (isPlaying) {
                    stop();
                    play(); 
                }
            });

            waveSelector.addEventListener('change', (e) => {
                synth.setWaveform(e.target.value);
            });
        }

        // --- Grid Logic ---

        function createGrid() {
            gridContainer.style.gridTemplateColumns = `repeat(${CONFIG.cols}, minmax(0, 1fr))`;
            gridContainer.style.gridTemplateRows = `repeat(${CONFIG.rows}, 1fr)`;
            gridContainer.innerHTML = '';

            for (let r = 0; r < CONFIG.rows; r++) {
                for (let c = 0; c < CONFIG.cols; c++) {
                    const cell = document.createElement('div');
                    
                    cell.className = `
                        grid-cell w-full h-full rounded-full border-2 
                        cursor-pointer touch-manipulation
                        bg-white border-stone-200
                    `;
                    
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    
                    cell.addEventListener('click', () => toggleCell(r, c, cell));
                    gridContainer.appendChild(cell);
                }
            }
        }

        function toggleCell(r, c, element) {
            const newState = !gridState[r][c];
            gridState[r][c] = newState;

            updateCellVisual(element, newState, r, c);

            if (newState) {
                // Animate pop
                element.animate([
                    { transform: 'scale(1)' },
                    { transform: 'scale(1.2)' },
                    { transform: 'scale(1)' }
                ], { duration: 200 });
                synth.playNote(r, 0.2);
            }
        }

        function updateCellVisual(element, active, r, c) {
            // This sets the BASE state of the cell (active or inactive)
            // The Playhead overlay handles temporary highlighting
            if (active) {
                element.style.backgroundColor = CONFIG.colors.activeTile;
                element.style.borderColor = CONFIG.colors.activeBorder;
                element.classList.add('shadow-md');
            } else {
                element.style.backgroundColor = CONFIG.colors.inactiveTile;
                element.style.borderColor = CONFIG.colors.inactiveBorder;
                element.classList.remove('shadow-md');
            }
        }

        function clearGrid() {
            gridState = gridState.map(row => row.map(() => false));
            Array.from(gridContainer.children).forEach(cell => {
                const r = parseInt(cell.dataset.row);
                const c = parseInt(cell.dataset.col);
                updateCellVisual(cell, false, r, c);
                // Ensure no residual playhead classes
                cell.classList.remove('playhead-column', 'playhead-active-note');
            });
            stop();
        }

        // --- Sequencer Logic ---

        function togglePlay() {
            if (isPlaying) stop();
            else play();
        }

        function play() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            isPlaying = true;
            playBtn.textContent = "Stop";
            playBtn.classList.remove('bg-stone-800');
            playBtn.classList.add('bg-red-800');
            
            const bpm = parseInt(tempoSlider.value);
            const msPerStep = (60 / bpm) * 1000 / 4; 
            
            intervalId = setInterval(nextStep, msPerStep);
        }

        function stop() {
            isPlaying = false;
            clearInterval(intervalId);
            playBtn.textContent = "Play";
            playBtn.classList.add('bg-stone-800');
            playBtn.classList.remove('bg-red-800');
            
            // Clean up visual playhead
            removePlayheadVisuals();
            currentStep = 0;
        }

        function nextStep() {
            // 1. Clean up previous column visual
            removePlayheadVisuals();

            // 2. Play Audio for Current Step
            for (let r = 0; r < CONFIG.rows; r++) {
                if (gridState[r][currentStep]) {
                    synth.playNote(r, 0.3);
                }
            }

            // 3. Draw new column visual
            drawPlayhead(currentStep);

            // 4. Advance
            currentStep++;
            if (currentStep >= CONFIG.cols) {
                currentStep = 0;
            }
        }

        function removePlayheadVisuals() {
            // More efficient than iterating everything: Use querySelectorAll for the specific class
            const activeElements = gridContainer.querySelectorAll('.playhead-column, .playhead-active-note');
            activeElements.forEach(el => {
                el.classList.remove('playhead-column', 'playhead-active-note');
            });
        }

        function drawPlayhead(colIndex) {
            // Find all cells in this column
            // We can calculate their indices or query them. Since grid is static, indices are faster.
            // But DOM query is safer if structure changes.
            const cells = gridContainer.children;
            
            for (let i = 0; i < cells.length; i++) {
                const cell = cells[i];
                const c = parseInt(cell.dataset.col);
                const r = parseInt(cell.dataset.row);

                if (c === colIndex) {
                    // This cell is in the active column
                    if (gridState[r][c]) {
                        // It has a note -> Highlighting Active Note
                        cell.classList.add('playhead-active-note');
                    } else {
                        // Empty cell -> Vertical Line Effect
                        cell.classList.add('playhead-column');
                    }
                }
            }
        }

        // --- State Management Helpers ---

        function captureAppState() {
            return {
                gridState: gridState, // Copy logic handled by JSON.stringify
                bpm: document.getElementById('tempo').value,
                waveform: document.getElementById('waveform').value,
                filter: document.getElementById('filter-cutoff').value,
                timestamp: Date.now()
            };
        }

        function loadSongIntoApp(songData) {
            if(!songData) return;

            // Stop playback
            stop();

            // Load Grid
            // We need to deep copy back to avoid reference issues
            gridState = JSON.parse(JSON.stringify(songData.gridState));
            
            // Update Visuals
            Array.from(gridContainer.children).forEach(cell => {
                const r = parseInt(cell.dataset.row);
                const c = parseInt(cell.dataset.col);
                const active = gridState[r][c];
                updateCellVisual(cell, active, r, c);
            });

            // Load Controls
            document.getElementById('tempo').value = songData.bpm;
            document.getElementById('tempo-val').textContent = songData.bpm;
            
            document.getElementById('waveform').value = songData.waveform;
            synth.setWaveform(songData.waveform);

            if(songData.filter) {
                document.getElementById('filter-cutoff').value = songData.filter;
            }
        }

        // Start the app
        window.addEventListener('load', init);

    </script>
</body>
</html>
